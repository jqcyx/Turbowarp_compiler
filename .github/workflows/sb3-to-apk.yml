name: SB3 è½¬ APK è‡ªåŠ¨æ„å»º
on:
  workflow_dispatch:
    inputs:
      package_name:
        description: 'APK åŒ…åï¼ˆç¬¦åˆ Android è§„èŒƒï¼Œä¾‹å¦‚ï¼šcom.example.myappï¼‰'
        required: true
        type: string
      app_name:
        description: 'åº”ç”¨æ˜¾ç¤ºåç§°ï¼ˆä¾‹å¦‚ï¼šæˆ‘çš„Scratchåº”ç”¨ï¼‰'
        required: true
        type: string
      sb3_filename:
        description: 'project æ–‡ä»¶å¤¹ä¸‹çš„ .sb3 æ–‡ä»¶åï¼ˆä¾‹å¦‚ï¼šdemo.sb3ï¼‰'
        required: true
        type: string

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      TURBOWARP_DIR: Turbowarp-packager
      PROJECT_DIR: ${{ github.workspace }}/project
      OUTPUT_HTML_DIR: ${{ github.workspace }}/output-html
      CORDOVA_DIR: ${{ github.workspace }}/cordova-project

    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: éªŒè¯ SB3 æ–‡ä»¶
        run: |
          SB3_PATH="${PROJECT_DIR}/${{ inputs.sb3_filename }}"
          if [ ! -f "$SB3_PATH" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ° SB3 æ–‡ä»¶ - $SB3_PATH"
            ls -la "$PROJECT_DIR"
            exit 1
          fi
          echo "âœ… æ‰¾åˆ° SB3 æ–‡ä»¶ï¼š$SB3_PATH"

      - name: å…‹éš† TurboWarp Packager
        run: |
          if [ ! -d "${TURBOWARP_DIR}" ]; then
            git clone https://github.com/TurboWarp/packager.git "${TURBOWARP_DIR}"
          fi
          # ç¡®ä¿ä»“åº“æ˜¯æœ€æ–°ç‰ˆæœ¬
          cd "${TURBOWARP_DIR}"
          git checkout main && git pull
          ls -la "${TURBOWARP_DIR}"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ${{ env.TURBOWARP_DIR }}/package-lock.json

      - name: æ„å»º Turbowarp Node.js ç‰ˆæœ¬ï¼ˆå…³é”®ä¿®æ­£ï¼šç”¨ build-node-prodï¼‰
        run: |
          cd "${TURBOWARP_DIR}"
          npm ci
          # æ‰§è¡Œ Node.js ä¸“å±æ„å»ºå‘½ä»¤ï¼ˆåŒ¹é… package.json ä¸­çš„è„šæœ¬ï¼‰
          npm run build-node-prod
          # éªŒè¯æ„å»ºäº§ç‰©ï¼ˆæ­¤æ—¶äº§ç‰©æ˜¯ dist/packager.js å•æ–‡ä»¶ï¼‰
          ls -la dist/ && ls -la dist/packager.js || echo "packager.js ä¸å­˜åœ¨"

      - name: ç”Ÿæˆè½¬æ¢è„šæœ¬ï¼ˆå…³é”®ä¿®æ­£ï¼šé€‚é…å•æ–‡ä»¶å…¥å£ + å®Œæ•´ Node.js é€‚é…ï¼‰
        run: |
          cat > "${TURBOWARP_DIR}/convert-sb3.js" << 'EOF'
          const fs = require('fs');
          const path = require('path');
          // ä¿®æ­£1ï¼šå¼•å…¥å•æ–‡ä»¶å…¥å£ dist/packager.js
          const Packager = require('./dist/packager');
          // ä¿®æ­£2ï¼šå¼•å…¥ Node.js é€‚é…å™¨ï¼ˆå¿…é¡»ï¼Œå¦åˆ™æ— æ³•åœ¨ Node.js ç¯å¢ƒè¿è¡Œï¼‰
          const NodeAdapter = require('./src/packager/node/adapter').default;

          // ç¯å¢ƒå˜é‡ä¼ å…¥çš„å‚æ•°
          const sb3Path = process.env.SB3_PATH;
          const outputHtmlPath = process.env.OUTPUT_HTML_PATH;

          // æ ¸å¿ƒè½¬æ¢é€»è¾‘
          const run = async () => {
            // æ­¥éª¤1ï¼šè®¾ç½® Node.js é€‚é…å™¨ï¼ˆTurbowarp å¿…é¡»ï¼‰
            Packager.setAdapter(new NodeAdapter());

            // æ­¥éª¤2ï¼šåˆ›å»ºè¾“å‡ºç›®å½•
            fs.mkdirSync(path.dirname(outputHtmlPath), { recursive: true });
            
            // æ­¥éª¤3ï¼šè¯»å– SB3 æ–‡ä»¶ï¼ˆNode.js ç¯å¢ƒè¯»å–ä¸º Bufferï¼‰
            console.log(`ğŸ“¥ è¯»å– SB3 æ–‡ä»¶: ${sb3Path}`);
            const projectBuffer = fs.readFileSync(sb3Path);
            // è½¬æ¢ä¸º ArrayBufferï¼ˆé€‚é… Turbowarp APIï¼‰
            const projectArrayBuffer = projectBuffer.buffer.slice(
              projectBuffer.byteOffset, 
              projectBuffer.byteOffset + projectBuffer.byteLength
            );

            // æ­¥éª¤4ï¼šåŠ è½½ Scratch é¡¹ç›®ï¼ˆé€‚é… Turbowarp Node.js APIï¼‰
            console.log('ğŸ”§ åŠ è½½é¡¹ç›®...');
            const loadedProject = await Packager.loadProject(projectArrayBuffer);

            // æ­¥éª¤5ï¼šåˆå§‹åŒ– Turbowarp æ‰“åŒ…å™¨
            const packager = new Packager.Packager();
            packager.project = loadedProject;
            packager.options = {
              target: 'html',       // æŒ‡å®šè¾“å‡ºä¸º HTML
              turbo: true,          // å¯ç”¨ Turbo æ¨¡å¼ä¼˜åŒ–
              standalone: true,     // ç”Ÿæˆç‹¬ç«‹ HTMLï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰
              compress: true        // å‹ç¼© HTML
            };

            // æ­¥éª¤6ï¼šæ‰§è¡Œæ‰“åŒ…
            console.log('âš™ï¸ è½¬æ¢ SB3 åˆ° HTML...');
            const result = await packager.package();

            // æ­¥éª¤7ï¼šå¤„ç†è¾“å‡ºæ•°æ®ï¼ˆå…¼å®¹ ArrayBuffer/Buffer/å­—ç¬¦ä¸²ï¼‰
            let htmlData = result.data;
            if (htmlData instanceof ArrayBuffer) {
              htmlData = Buffer.from(htmlData).toString('utf8');
            } else if (Buffer.isBuffer(htmlData)) {
              htmlData = htmlData.toString('utf8');
            }

            // æ­¥éª¤8ï¼šå†™å…¥ HTML æ–‡ä»¶
            fs.writeFileSync(outputHtmlPath, htmlData, 'utf8');
            console.log(`âœ… HTML ç”Ÿæˆå®Œæˆ: ${outputHtmlPath}`);
          };

          // æ‰§è¡Œå¹¶æ•è·é”™è¯¯
          run().catch((err) => {
            console.error('âŒ è½¬æ¢å¤±è´¥:', err);
            process.exit(1);
          });
          EOF
        env:
          SB3_PATH: ${{ env.PROJECT_DIR }}/${{ inputs.sb3_filename }}
          OUTPUT_HTML_PATH: ${{ env.OUTPUT_HTML_DIR }}/index.html

      - name: è½¬æ¢ SB3 åˆ° HTML
        run: |
          cd "${TURBOWARP_DIR}"
          node convert-sb3.js

      - name: å®‰è£… Android & Cordova ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openjdk-17-jdk \
            android-sdk \
            gradle \
            unzip \
            wget

          npm install -g cordova@12.0.0

          echo "ANDROID_HOME=/usr/lib/android-sdk" >> $GITHUB_ENV
          echo "PATH=\$PATH:/usr/lib/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_ENV

          # è‡ªåŠ¨æ¥å— Android è®¸å¯è¯
          yes | sdkmanager --licenses || true
          # å®‰è£… Android 34 æ„å»ºå·¥å…·
          sdkmanager "platforms;android-34" "build-tools;34.0.0" "platform-tools"

      - name: ç”¨ Cordova æ‰“åŒ… HTML ä¸º APK
        run: |
          mkdir -p "${CORDOVA_DIR}"
          cd "${CORDOVA_DIR}"

          # åˆ›å»º Cordova é¡¹ç›®
          cordova create app ${{ inputs.package_name }} "${{ inputs.app_name }}"
          cd app

          # æ·»åŠ  Android å¹³å°
          cordova platform add android@12.0.0

          # æ›¿æ¢ Cordova é»˜è®¤ www ç›®å½•ä¸ºç”Ÿæˆçš„ HTML
          rm -rf www/*
          cp -r "${OUTPUT_HTML_DIR}"/* www/

          # æ„å»º APKï¼ˆdebug ç‰ˆæœ¬ï¼‰
          cordova build android --debug

          # æŸ¥æ‰¾å¹¶å¤åˆ¶ APK æ–‡ä»¶
          APK_PATH=$(find platforms/android/app/build/outputs/apk/debug -name "*.apk" | head -1)
          if [ -f "$APK_PATH" ]; then
            cp "$APK_PATH" "${CORDOVA_DIR}/${{ inputs.app_name }}_debug.apk"
            echo "âœ… APK ç”Ÿæˆå®Œæˆ: ${CORDOVA_DIR}/${{ inputs.app_name }}_debug.apk"
          else
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„ APK æ–‡ä»¶"
            ls -la platforms/android/app/build/outputs/apk/debug/
            exit 1
          fi

      - name: ä¸Šä¼  APK äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-apk-${{ github.run_id }}
          path: ${{ env.CORDOVA_DIR }}/${{ inputs.app_name }}_debug.apk
          retention-days: 30
